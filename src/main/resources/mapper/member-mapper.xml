<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kh.foodreport.domain.member.model.dao.MemberMapper">
	
	<!-- 회원가입 -->
	<insert id="signUp"
		parameterType="MemberVO">
		INSERT 
		  INTO 
		  	   FR_MEMBER 
		VALUES 
			   (
			   SEQ_MEMBER_NO.NEXTVAL
			 , #{email}
			 , #{password}
			 , #{nickname}
			 , #{phone}
			 , #{introduce}
			 , SYSDATE
			 , NULL
			 , NULL
			 , 'Y'
			 , 'ROLE_USER'
			   )
	</insert>
	
	<!-- 이메일 중복 확인 -->
	<select id="countByEmail"
			resultType="int" parameterType="string">		
		SELECT 
		       COUNT(*) 
		  FROM 
		  	   FR_MEMBER 
		 WHERE 
		 	   EMAIL = #{email}
	</select>
	
	<!-- 로그인 -->
	<select id="loadUser"
			resultType="MemberDTO" parameterType="string">	
		SELECT 
			   MEMBER_NO memberNo
		     , EMAIL email
		 	 , PASSWORD password
		 	 , NICKNAME nickname
		 	 , PHONE phone
		 	 , status
		 	 , role
	  	  FROM 
	           FR_MEMBER
	 	 WHERE 
	       	   EMAIL = #{username}
	</select>
	
	<!-- 비밀번호 변경 -->
	<update id="updatePassword"
			parameterType="Map">
		UPDATE 
			   FR_MEMBER 
		   SET 
		   	   PASSWORD = #{newPassword} 
		 WHERE 
		       EMAIL = #{email}
	</update>
	
	<!-- 회원 탈퇴 -->
	<update id="deleteMember"
			parameterType="String">
		UPDATE  
		  	   FR_MEMBER
		   SET
		       STATUS = 'N' 
		 WHERE 
		 	   EMAIL = #{email}		
	</update>
	
	<!-- 로그인 검증용 -->
	<select id="loadUserByMemberNo"
			resultType="MemberDTO" parameterType="Long">	
		SELECT 
			   MEMBER_NO memberNo
		     , EMAIL email
		 	 , PASSWORD password
		 	 , NICKNAME nickname
		 	 , PHONE phone
		 	 , status
		 	 , role
	  	  FROM 
	           FR_MEMBER
	 	 WHERE 
	       	   MEMBER_NO = #{memberNo}
	</select>
	
	<!-- 프로필 이미지 저장 -->
	<insert id="saveImage" 
			parameterType="MemberImage">
		INSERT
		  INTO
		       FR_MEMBER_IMAGE
		       (
		       IMAGE_NO
		     , ORIGIN_NAME
		     , CHANGE_NAME
		     , MEMBER_NO
		     , CREATE_DATE
		     , STATUS
		       )
		VALUES
		       (
		       SEQ_MEMBER_IMAGE_NO.NEXTVAL
		     , #{originName}
		     , #{changeName}
		     , #{refMemberNo}
		     , SYSDATE
		     , 'Y'
		       )
	</insert>
	
	<!-- 프로필 이미지 수정-->
	<update id="updateImage">
		UPDATE 
			   FR_MEMBER_IMAGE
		   SET 
		   	   ORIGIN_NAME = #{originName}
		  	 , CHANGE_NAME = #{changeName}
		  	 , UPDATE_DATE = SYSDATE
		 WHERE
		 	   MEMBER_NO = #{refMemberNo}		
		
	</update>
	
	<!-- 프로필 이미지 삭제 -->
	<update id="deleteImage" 
				parameterType="long">
		UPDATE
		       FR_MEMBER_IMAGE
		   SET
		       STATUS = 'N'
		     , DELETE_DATE = SYSDATE
		 WHERE
		       IMAGE_NO = #{imageNo}
		   AND
		       STATUS = 'Y'
	</update>


	
	<resultMap id="findByMemberNo" type="memberDTO">
		<id column="memberNo" property="memberNo"/>
		<result column="nickname" property="nickname"/>
		<result column="phone" property="phone"/>
		<result column="introduce" property="introduce" />
		<result column="memberCreateDate" property="createDate"/>
		<collection property="memberImages" ofType="MemberImageDTO">
			<id column="imageNo" property="imageNo"/>
			<result column="changeName" property="changeName"/>
			<result column="imageCreateDate" property="createDate" />
		</collection>
		<collection property="restaurants" ofType="RestaurantDTO">
			<id column="restaurantNo" property="restaurantNo"/>
			<result column="restautantName" property="restaurantName"/>
			<result column="address" property="address"/>
			<result column="restaurantCreateDate" property="createDate"/>
		</collection>	
	</resultMap>
	
	<!-- 회원 정보 조회 -->
	<select id="findByMemberNo" 
			resultMap="findByMemberNo" 
			parameterType="long">
		SELECT
		       EMAIL email
		     , NICKNAME nickname
		     , PHONE phone
		     , INTRODUCE introduce
		     , MEMBER.CREATE_DATE memberCreateDate
		     , IMAGE_NO imageNo
		     , IMG.CHANGE_NAME changeName
		     , IMG.CREATE_DATE imageCreateDate
		     , IMG.STATUS imageStatus
		     , RESTAURANT.RESTAURANT_NO restaurantNo
		     , RESTAURANT.RESTAURANT_NAME restaurantName
		     , RESTAURANT.ADDRESS address
		     , RESTAURANT.CREATE_DATE restaurantCreateDate
		  FROM
		       FR_MEMBER MEMBER
		  LEFT
		  JOIN
		       FR_RESTAURANT RESTAURANT ON (MEMBER.MEMBER_NO = RESTAURANT.MEMBER_NO)
		  LEFT
		  JOIN
		       FR_MEMBER_IMAGE IMG ON (IMG.MEMBER_NO = MEMBER.MEMBER_NO AND IMG.STATUS = 'Y')
		 WHERE
		       MEMBER.STATUS = 'Y'
		   AND
		       MEMBER.MEMBER_NO = #{memberNo}
		 ORDER
		    BY
		       IMG.CREATE_DATE ASC
	</select>	
	
	<!-- 프로필 이미지 조회 -->
	<select id="findUrlByMemberNo"
		resultType="String">
		SELECT
			   I.CHANGE_NAME memberImages
		  FROM 
		  	   FR_MEMBER M
		  LEFT 
		  JOIN 
		  	   FR_MEMBER_IMAGE I
		  	ON 
		  	   I.MEMBER_NO = M.MEMBER_NO 
		   AND 
		       I.STATUS = 'Y'
		 WHERE 
		  	   M.MEMBER_NO = #{memberNo}
		   AND 
		  	   M.STATUS = 'Y'
	</select>
	
	<!-- 회원 정보 수정 -->
	<update id="updateMember">
		UPDATE 
			   FR_MEMBER
		   SET 
		   	   NICKNAME = #{nickname}
		   	 , PHONE = #{phone}
		   	 , INTRODUCE = #{introduce}
		   	 , UPDATE_DATE = SYSDATE
		 WHERE
		 	   MEMBER_NO = #{memberNo}
	</update>
	
	<!-- 리뷰 개수 조회 -->
	<select id="countByReviews" 
			resultType="int" parameterType="long">
		SELECT
		       COUNT(*)
		  FROM
		       FR_REVIEW
		 WHERE 
		       MEMBER_NO = #{memberNo} 
		   AND 
		       STATUS = 'Y'
    </select>
    
    <!-- 회원 리뷰 전체 조회 -->
    <select id="findAllReviews"
    		parameterType="map"
    		resultType="MemberReviewDTO">
 		SELECT
			   REVIEW.REVIEW_NO reviewNo
			 , REVIEW.REVIEW_TITLE reviewTitle
			 , REVIEW.REVIEW_CONTENT reviewContent
			 , REVIEW.CREATE_DATE createDate
			 , REVIEW.STATUS status
			 , REVIEW.VIEW_COUNT viewCount
			 , REVIEW.UPDATE_DATE updateDate
			 , REVIEW.DELETE_DATE deleteDate
			 , MEMBER.NICKNAME nickname
			 , (SELECT 
			    	   COUNT(*)
			  	  FROM
			  	  	   FR_REVIEW_LIKE
			  	 WHERE
			  	 	   REVIEW_NO = FR_REVIEW_LIKE.REVIEW_NO) AS LIKES
	 	  FROM 
	   	       FR_REVIEW REVIEW
	   	  LEFT 
	      JOIN 
	           FR_MEMBER MEMBER ON (REVIEW.MEMBER_NO = MEMBER.MEMBER_NO)
	     WHERE 
	 	       REVIEW.MEMBER_NO = #{memberNo} 
		   AND 
	   		   REVIEW.STATUS = 'Y'  	           
	  	 ORDER 
	        BY 
	  	       REVIEW_NO DESC
	    OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
	</select>
	
	<!-- 사업자번호 중복 확인 -->
	<select id="countByBusinessNo"
			resultType="int" parameterType="string">		
		SELECT 
		       COUNT(*) 
		  FROM 
		  	   FR_RESTAURANT
		 WHERE 
		 	   BUSINESS_NO = #{businessNo}
	</select>
	
		<!-- 사업자 등록 -->
	<insert id="saveOwner"
			parameterType="RestaurantVO">
		INSERT 
		  INTO 
		       FR_RESTAURANT
		       (
		       RESTAURANT_NO
		     , BUSINESS_NO
		     , RESTAURANT_NAME
		     , ADDRESS
		     , STATUS
		     , CREATE_DATE
		     , MEMBER_NO
		       )
		VALUES 
		       (
		       SEQ_RESTAURANT_NO.NEXTVAL
		     , #{businessNo}
		     , #{restaurantName}
		     , #{address}
		     , 'Y'
		     , SYSDATE
		     , #{refMemberNo}
		       )
	</insert>
	
	<!-- 좋아요 수 -->
	<select id="countLikes" 
			parameterType="ReviewLike" 
			resultType="int">
		SELECT
		       COUNT(*)
		  FROM
		       FR_REVIEW_LIKE
		 WHERE
		       MEMBER_NO = #{memberNo}
		   AND 
		       REVIEW_NO = #{reviewNo}
	</select>
	

	
	
			   
		       
    

	
</mapper>
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kh.foodreport.domain.admin.notice.model.dao.AdminNoticeMapper">
	
	<!-- 공지사항 insert -->
	<insert id = "saveNotice"
		parameterType="AdminNoticeDTO"
		>
	<selectKey resultType="long" keyProperty="noticeNo" order="BEFORE">
		SELECT SEQ_NOTICE_NO.NEXTVAL FROM DUAL
	</selectKey>
		INSERT 
  		  INTO 
  	   		   FR_NOTICE
  	   		   (
  	   		   NOTICE_NO,
  	   		   NOTICE_TITLE,
  	   		   NOTICE_CONTENT,
  	   		   VIEW_COUNT,
  	   		   STATUS,
  	   		   CREATE_DATE,
  	   		   UPDATE_DATE,
  	   		   DELETE_DATE,
  	   		   MEMBER_NO
  	   		   )
		VALUES 
	   		   (
	   			 #{noticeNo},
	   			 #{noticeTitle},
	   			 #{noticeContent},
	   			 DEFAULT,
	   			 DEFAULT,
	   			 DEFAULT,
	   			 NULL,
	   			 NULL,
	   			 #{refMemberNo}
	   		   )
	</insert>
	
	<!-- 공지사항 이미지 insert -->
	<insert id = "saveImage"
		parameterType="AdminNoticeImage">
		INSERT
		  INTO
		  	   FR_NOTICE_IMAGE
		  	   (
		  	   IMAGE_NO,
		  	   ORIGIN_NAME,
		  	   CHANGE_NAME,
		  	   STATUS,
		  	   CREATE_DATE,
		  	   UPDATE_DATE,
		  	   DELETE_DATE,
		  	   NOTICE_NO
		  	   )
		VALUES 
			   (
			   SEQ_NOTICE_IMAGE_NO.NEXTVAL,
			   #{originName},
			   #{changeName},
			   DEFAULT,
			   DEFAULT,
			   NULL,
			   NULL,
			   #{refNoticeNo}
			   )
	</insert>
	
	<!-- 공지사항 전체 목록 조회 -->
	<select id="findAllNotices"
		resultType="AdminNoticeDTO" parameterType="map">
		SELECT
			   N.NOTICE_NO noticeNo
			 , N.NOTICE_TITLE noticeTitle
			 , N.NOTICE_CONTENT noticeContent
			 , N.VIEW_COUNT viewCount
			 , N.STATUS status
			 , N.CREATE_DATE createDate
			 , N.UPDATE_DATE updateDate
			 , N.DELETE_DATE deleteDate
			 , N.MEMBER_NO refMemberNo
			 , I.CHANGE_NAME noticeImageUrl
		  FROM FR_NOTICE N
		  LEFT JOIN FR_NOTICE_IMAGE I ON I.NOTICE_NO = N.NOTICE_NO
		  ORDER BY N.NOTICE_NO DESC
		 OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
	</select>
	
		<!-- 공지사항 키워드 목록 조회 -->
	<select id="findByNoticeTitle"
		resultType="AdminNoticeDTO" parameterType="map">
		SELECT
			   N.NOTICE_NO noticeNo
			 , N.NOTICE_TITLE noticeTitle
			 , N.NOTICE_CONTENT noticeContent
			 , N.VIEW_COUNT viewCount
			 , N.STATUS status
			 , N.CREATE_DATE createDate
			 , N.UPDATE_DATE updateDate
			 , N.DELETE_DATE deleteDate
			 , N.MEMBER_NO refMemberNo
			 , I.CHANGE_NAME noticeImageUrl
		  FROM FR_NOTICE N
		  LEFT JOIN FR_NOTICE_IMAGE I ON I.NOTICE_NO = N.NOTICE_NO
		  WHERE N.NOTICE_TITLE LIKE '%' || #{noticeTitle} || '%' 
		  ORDER BY N.NOTICE_NO DESC
		 OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
	</select>
	
	<!-- 전체 목록 카운트 -->
	<select id="countByNotices"
		resultType="_int">
		SELECT
			   COUNT(*)
	      FROM
	      	   FR_NOTICE
	</select>
	
	<!-- 키워드(공지사항 제목) 갯수 카운트 -->
	<select id="countByNoticeTitle"
		resultType="_int">
		SELECT 
			   COUNT(*)
		  FROM
		       FR_NOTICE
		 WHERE NOTICE_TITLE LIKE '%' || #{noticeTitle} || '%'
	</select>
	
	<!-- 이미지 테이블 삭제 -->
	<update id="deleteNoticeImage">
		UPDATE 
			   FR_NOTICE_IMAGE
		   SET 
		       STATUS = 'N'
		     , DELETE_DATE = SYSDATE
		 WHERE
		 	   NOTICE_NO = #{refNoticeNo}
	</update>
	
	<!-- 공지사항 테이블 삭제-->
	<update id="deleteNotice">
		UPDATE
			   FR_NOTICE
		   SET
		   	   STATUS = 'N'
		   	 , DELETE_DATE = SYSDATE
		 WHERE
		 	   NOTICE_NO = #{noticeNo}
	</update>
	
	<!-- 공지사항 이미지가 있는지 조회 -->
	<select id="countByNoticeNo"
		resultType="String">
		SELECT
			   I.CHANGE_NAME noticeImageUrl
		  FROM FR_NOTICE N
		  LEFT JOIN FR_NOTICE_IMAGE I ON I.NOTICE_NO = N.NOTICE_NO AND I.STATUS = 'Y'
		  WHERE N.NOTICE_NO = #{noticeNo}
		  	AND N.STATUS = 'Y'
	</select>
	
	<!-- 공지사항 이미지 테이블 변경 기능 -->
	<update id="updateImage">
		UPDATE 
			   FR_NOTICE_IMAGE
		   SET 
		   	   ORIGIN_NAME = #{originName}
		  	 , CHANGE_NAME = #{changeName}
		  	 , UPDATE_DATE = SYSDATE
		 WHERE
		 	   NOTICE_NO = #{refNoticeNo}
	</update>
	
		<!-- 공지사항 테이블 변경 기능 -->
	<update id="updateNotice">
		UPDATE 
			   FR_NOTICE
		   SET 
		   	   NOTICE_TITLE = #{noticeTitle}
		   	 , NOTICE_CONTENT = #{noticeContent}
		   	 , UPDATE_DATE = SYSDATE
		 WHERE
		 	   NOTICE_NO = #{noticeNo}
	</update>
</mapper>
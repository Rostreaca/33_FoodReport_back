<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kh.foodreport.domain.review.model.dao.ReviewMapper">
	
	<insert id="saveReview" parameterType="ReviewDTO">
		<selectKey resultType="long" keyProperty="reviewNo" order="BEFORE">
			SELECT SEQ_REVIEW_NO.NEXTVAL FROM DUAL
		</selectKey>
		INSERT
		  INTO
		       FR_REVIEW
		       (
		       REVIEW_NO
		     , REVIEW_TITLE
		     , REVIEW_CONTENT
		     , MEMBER_NO
		     , CREATE_DATE
		     , STATUS
		       )
		VALUES
		       (
		       #{reviewNo}
		     , #{reviewTitle}
		     , #{reviewContent}
		     , #{reviewWriter}
		     , SYSDATE
		     , 'Y'
		       )		
	</insert>
	
	<insert id="saveTagByReviewNo" parameterType="map">
		INSERT ALL
		 <foreach collection="tagNums" item="tagNo">
		  INTO
		       FR_REVIEW_TAG
		       (
		       TAG_NO
		     , REVIEW_NO
		     , CREATE_DATE
		       )
		VALUES
		       (
		       #{tagNo}
		     , #{reviewNo}
		     , SYSDATE
		       )
		</foreach>
		SELECT
		       *
		  FROM
		       DUAL
	</insert>
	
	<insert id="saveImage" parameterType="ReviewImage">
		INSERT
		  INTO
		       FR_REVIEW_IMAGE
		       (
		       IMAGE_NO
		     , ORIGIN_NAME
		     , CHANGE_NAME
		     , REVIEW_NO
		     , CREATE_DATE
		     , STATUS
		     , IMAGE_LEVEL
		       )
		VALUES
		       (
		       SEQ_REVIEW_IMAGE_NO.NEXTVAL
		     , #{originName}
		     , #{changeName}
		     , #{refReviewNo}
		     , SYSDATE
		     , 'Y'
		     , #{imageLevel}
		       )
	</insert>
	
	<select id="countByReviews" resultType="_int" parameterType="map">
		
		SELECT
		       COUNT(*)
		  FROM
		       FR_REVIEW REVIEW
		  <if test="tagNo != 0">
		  LEFT
		  JOIN
		       FR_REVIEW_TAG REVIEWTAG ON (REVIEWTAG.REVIEW_NO = REVIEW.REVIEW_NO)
		  </if>
		 WHERE
		       REVIEW.STATUS = 'Y'
		  <if test="keyword != ''">
		   AND
			   REVIEW_TITLE LIKE '%' || #{keyword} || '%'
		  </if>
		  <if test="tagNo != 0">
		   AND
		       TAG_NO = #{tagNo}
		   </if>
		       
    </select>
	
	<resultMap id="findAllReviews" type="ReviewDTO">
		<id column="reviewNo" property="reviewNo"/>
		<result column="reviewTitle" property="reviewTitle"/>
		<result column="reviewContent" property="reviewContent"/>
		<result column="reviewWriter" property="reviewWriter" />
		<result column="profileImage" property="profileImage" />
		<result column="viewCount" property="viewCount"/>
		<result column="likes" property="likes" />
		<result column="reviewCreateDate" property="createDate" />
		<collection property="reviewImages" ofType="ReviewImageDTO">
			<id column="imageNo" property="imageNo"/>
			<result column="changeName" property="changeName"/>
			<result column="imageLevel" property="imageLevel"/>
		</collection>
		<collection property="tags" ofType="TagDTO">
			<id column="tagNo" property="tagNo"/>
			<result column="tagTitle" property="tagTitle"/>
			<result column="tagContent" property="tagContent"/>
		</collection>
	</resultMap>
	
	<select id="findAllReviews" resultMap="findAllReviews" parameterType="map">
		SELECT
		       REVIEW.REVIEW_NO reviewNo
		     , REVIEW_TITLE reviewTitle
		     , REVIEW_CONTENT reviewContent
		     , NICKNAME reviewWriter
		     , MEMBERIMG.CHANGE_NAME profileImage
		     , VIEW_COUNT viewCount
		     , (SELECT 
		               COUNT(*)
		          FROM
		               FR_REVIEW_LIKE
		         WHERE
		               REVIEW.REVIEW_NO = FR_REVIEW_LIKE.REVIEW_NO) AS likes
		     , REVIEW.CREATE_DATE reviewCreateDate
		     , IMG.IMAGE_NO imageNo
		     , IMG.CHANGE_NAME changeName
		     , IMG.IMAGE_LEVEL imageLevel
		     , TAG.TAG_NO tagNo
		     , TAG.TAG_TITLE tagTitle
		     , TAG.TAG_CONTENT tagContent
		  FROM
		  	   (
		  	   SELECT 
		  	          REVIEW_NO
				    , REVIEW_TITLE
				    , REVIEW_CONTENT
				    , MEMBER_NO
				    , VIEW_COUNT
				    , (SELECT 
				              COUNT(*)
				         FROM
				              FR_REVIEW_LIKE
				        WHERE
				              REVIEW_NO = FR_REVIEW_LIKE.REVIEW_NO) AS LIKES
				    , REVIEW.CREATE_DATE
		  	     FROM
		  	          FR_REVIEW REVIEW
	  	          <if test="tagNo != 0">
		  	     LEFT
		  	     JOIN
		  	          FR_REVIEW_TAG USING (REVIEW_NO)
		  	     LEFT
		  	     JOIN
		  	          FR_TAG TAG USING (TAG_NO)
	  	          </if>
		  	    WHERE
		              REVIEW.STATUS = 'Y'
				 	<if test="keyword != ''">
				  AND
				      REVIEW_TITLE LIKE '%' || #{keyword} || '%'
					</if>
					<if test="tagNo != 0">
				  AND
				      TAG_NO = #{tagNo}
				    </if>
		   		ORDER
				   BY 
				 <choose>
					<when test="order == 'likes'">
					  LIKES DESC
					</when>
					 <otherwise>
				       CREATE_DATE DESC
					 </otherwise>
				 </choose>
 					<if test="tagNo != 0">
					 , TAG_TITLE ASC
					</if>
			   OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY	
		  	   ) REVIEW
		  LEFT
		  JOIN
		       FR_MEMBER MEMBER ON (MEMBER.MEMBER_NO = REVIEW.MEMBER_NO)
		  LEFT
		  JOIN
		       FR_MEMBER_IMAGE MEMBERIMG ON (MEMBER.MEMBER_NO = MEMBERIMG.MEMBER_NO)
		  LEFT
		  JOIN
		       FR_REVIEW_IMAGE IMG ON (REVIEW.REVIEW_NO = IMG.REVIEW_NO AND IMAGE_LEVEL = 0 AND IMG.STATUS ='Y')
		  LEFT
		  JOIN
		       FR_REVIEW_TAG REVIEWTAG ON (REVIEWTAG.REVIEW_NO = REVIEW.REVIEW_NO)
		  LEFT
		  JOIN
		       FR_TAG TAG ON (REVIEWTAG.TAG_NO = TAG.TAG_NO)
		 ORDER
		    BY 
		    <choose>
				<when test="order == 'likes'">
			   LIKES DESC
				</when>
			    <otherwise>
		       REVIEW.CREATE_DATE DESC
				</otherwise>
			</choose>
			 , REVIEW.REVIEW_NO DESC
 				<if test="tagNo != 0">
	 		 , TAG.TAG_TITLE ASC
			 	</if>
		
	</select>
	
	<update id="updateViewCount" parameterType="long">
		UPDATE
		       FR_REVIEW
		   SET
		       VIEW_COUNT = VIEW_COUNT + 1
		 WHERE
		       REVIEW_NO = #{reviewNo}
	</update>
		
	
	
	<select id="findReviewByReviewNo" resultType="ReviewDTO" parameterType="long">
		SELECT
			   REVIEW_NO reviewNo
		     , REVIEW_TITLE reviewTitle
		     , REVIEW_CONTENT reviewContent
		     , MEMBER.MEMBER_NO memberNo
		     , NICKNAME reviewWriter
		     , MEMBERIMG.CHANGE_NAME profileImage
		     , VIEW_COUNT viewCount
		     , (SELECT 
		               COUNT(*)
		          FROM
		               FR_REVIEW_LIKE
		         WHERE
		               REVIEW.REVIEW_NO = FR_REVIEW_LIKE.REVIEW_NO) AS likes
		     , REVIEW.CREATE_DATE createDate
		  FROM
		       FR_REVIEW REVIEW
		  JOIN
		       FR_MEMBER MEMBER ON (REVIEW.MEMBER_NO = MEMBER.MEMBER_NO)
		  LEFT
		  JOIN
		       FR_MEMBER_IMAGE MEMBERIMG ON (MEMBER.MEMBER_NO = MEMBERIMG.MEMBER_NO)
		 WHERE
		       REVIEW.STATUS = 'Y'
		   AND
		       REVIEW.REVIEW_NO = #{reviewNo}
		       
	</select>
	
	<select id="findTagByReviewNo" parameterType="long" resultType="TagDTO">
		SELECT
		       TAG_NO tagNo
		     , TAG_TITLE tagTitle
		     , TAG_CONTENT tagContent
		  FROM
		       FR_TAG
		  LEFT
		  JOIN
		       FR_REVIEW_TAG USING (TAG_NO)
		 WHERE
		       REVIEW_NO = #{reviewNo}
		   AND
		       STATUS = 'Y'
		 ORDER
		    BY
		       TAG_TITLE ASC
	</select>
	
	<select id="findRepliesByReviewNo" parameterType="long" resultType="ReviewReplyDTO">
		SELECT
		       REPLY_NO replyNo
		     , REPLY_CONTENT replyContent
		     , MEMBER.MEMBER_NO memberNo
		     , NICKNAME replyWriter
		     , MEMBERIMG.CHANGE_NAME profileImage
		     , (SELECT 
		               COUNT(*)
		          FROM
		               FR_REVIEW_REPLY_LIKE
		         WHERE
		               REPLY.REPLY_NO = FR_REVIEW_REPLY_LIKE.REPLY_NO) AS likes
		     , REPLY.CREATE_DATE createDate
		  FROM
		       FR_REVIEW_REPLY REPLY
		  JOIN
		       FR_MEMBER MEMBER ON (REPLY.MEMBER_NO = MEMBER.MEMBER_NO)		  
		  LEFT
		  JOIN
		       FR_MEMBER_IMAGE MEMBERIMG ON (MEMBER.MEMBER_NO = MEMBERIMG.MEMBER_NO)
		 WHERE
		       REPLY.STATUS = 'Y'
		   AND
		       REVIEW_NO = #{reviewNo}
		 ORDER
		    BY
		       REPLY.CREATE_DATE DESC
	</select>
	
	<update id="updateReview" parameterType="ReviewDTO">
		UPDATE
		       FR_REVIEW
		   SET
		       REVIEW_TITLE = #{reviewTitle}
		     , REVIEW_CONTENT = #{reviewContent}
		     , UPDATE_DATE = SYSDATE
		 WHERE
		       REVIEW_NO = #{reviewNo}
		   AND
		       STATUS = 'Y'
		   AND
		       MEMBER_NO = #{reviewWriter}
		
	</update>
	
	<select id="findImagesByReviewNo" resultType="ReviewImageDTO" parameterType="long">
		SELECT
		       IMAGE_NO imageNo
		     , ORIGIN_NAME originName
		     , CHANGE_NAME changeName
		     , IMAGE_LEVEL imageLevel
		  FROM
		       FR_REVIEW_IMAGE
		 WHERE
		       REVIEW_NO = #{reviewNo}
		   AND
		       STATUS = 'Y'
		 ORDER
		    BY
		       IMAGE_LEVEL ASC, CREATE_DATE DESC
	</select>
	
	<update id="deleteImage" parameterType="long">
		UPDATE
		       FR_REVIEW_IMAGE
		   SET
		       STATUS = 'N'
		     , DELETE_DATE = SYSDATE
		 WHERE
		       IMAGE_NO = #{imageNo}
		   AND
		       STATUS = 'Y'
	</update>
	
	
	<update id="deleteReview" parameterType="long">
		UPDATE
		       FR_REVIEW
		   SET
		       STATUS = 'N'
		     , DELETE_DATE = SYSDATE
		 WHERE
		       STATUS = 'Y'
		   AND
		       REVIEW_NO = #{reviewNo}
		
	</update>
	
	<delete id="deleteTags" parameterType="long">
		DELETE
		  FROM
		       FR_REVIEW_TAG
		 WHERE
		       REVIEW_NO = #{reviewNo}
    </delete>
	
	<update id="deleteReplies" parameterType="long">
		UPDATE
		       FR_REVIEW_REPLY
		   SET
		       STATUS = 'N'
		     , DELETE_DATE = SYSDATE
		 WHERE
		       REVIEW_NO = #{reviewNo}
		   AND
		       STATUS = 'Y'
	</update>
	
	<insert id="saveReply" parameterType="ReviewReply">
		INSERT
		  INTO
		       FR_REVIEW_REPLY
		       (
		       REPLY_NO
		     , REPLY_CONTENT
		     , MEMBER_NO
		     , REVIEW_NO
		     , CREATE_DATE
		       )
	    VALUES
		       (
		       SEQ_REVIEW_REPLY_NO.NEXTVAL
		     , #{replyContent}
		     , #{replyWriter}
		     , #{refReviewNo}
		     , SYSDATE
		       )
	</insert>
	
	<select id="countLikeByMember" parameterType="ReviewLike" resultType="_int">
		SELECT
		       COUNT(*)
		  FROM
		       FR_REVIEW_LIKE
		 WHERE
		       MEMBER_NO = #{memberNo}
		   AND 
		       REVIEW_NO = #{reviewNo}
	</select>
	
	<insert id="saveLike" parameterType="ReviewLike">
		INSERT
		  INTO
		       FR_REVIEW_LIKE
		       (
		       MEMBER_NO
		     , REVIEW_NO
		     , CREATE_DATE
		       )
		VALUES
		       (
		       #{memberNo}
		     , #{reviewNo}
		     , SYSDATE
		       )
		
	</insert>
	
	<delete id="deleteLike" parameterType="ReviewLike">
		DELETE
		  FROM
		       FR_REVIEW_LIKE
		 WHERE
		       MEMBER_NO = #{memberNo}
		   AND 
		       REVIEW_NO = #{reviewNo}
	</delete>
	
	<select id="countByReviewNo" parameterType="long">
		SELECT
		       COUNT(*)
		  FROM
		       FR_REVIEW
		 WHERE
		       STATUS = 'Y'
		   AND
		       REVIEW_NO = #{reviewNo}
	</select>
	
	
	
</mapper>